<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ã–deme Takip (Firebase) â€” Tek Dosya</title>
  <style>
    :root { --bg:#0b1220; --card:#121a2b; --muted:#8aa0c7; --text:#e9f1ff; --line:#1f2a44; --ok:#2dd4bf; --bad:#fb7185; --warn:#fbbf24; }
    *{box-sizing:border-box} body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;background:linear-gradient(180deg,#071022, #0b1220);color:var(--text)}
    a{color:inherit}
    .wrap{max-width:1100px;margin:0 auto;padding:18px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;margin-bottom:14px}
    .brand{display:flex;flex-direction:column;gap:2px}
    .brand h1{font-size:16px;margin:0;letter-spacing:.3px}
    .brand small{color:var(--muted)}
    .row{display:flex;gap:12px;flex-wrap:wrap}
    .card{background:rgba(18,26,43,.92);border:1px solid var(--line);border-radius:14px;padding:12px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .card h2{margin:0 0 10px;font-size:13px;color:#cfe0ff}
    .btn{background:#1a2743;border:1px solid #263a63;color:var(--text);border-radius:12px;padding:10px 12px;cursor:pointer;font-weight:600}
    .btn:hover{filter:brightness(1.08)}
    .btn.primary{background:#2b4cff;border-color:#314fe7}
    .btn.ghost{background:transparent}
    .btn.danger{background:#3a1b2a;border-color:#5f243f}
    .btn.ok{background:#0f2f2d;border-color:#175b56}
    .pill{border:1px solid var(--line);background:#0e162a;border-radius:999px;padding:8px 10px;color:#cfe0ff;display:inline-flex;gap:8px;align-items:center}
    .grid3{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
    @media (max-width:820px){ .grid3{grid-template-columns:1fr} header{flex-direction:column;align-items:flex-start} }
    .kpi{display:flex;flex-direction:column;gap:6px}
    .kpi .v{font-size:20px;font-weight:800;letter-spacing:.3px}
    .kpi .l{color:var(--muted);font-size:12px}
    .v.ok{color:var(--ok)} .v.bad{color:var(--bad)}
    .toolbar{display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between}
    .controls{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    input,select{background:#0e162a;border:1px solid var(--line);color:var(--text);border-radius:12px;padding:10px 12px;outline:none}
    input::placeholder{color:#6f86b2}
    .list{width:100%;border-collapse:collapse}
    .list th,.list td{border-bottom:1px solid var(--line);padding:10px 8px;text-align:left;font-size:13px}
    .list th{color:#bcd1ff;font-size:12px}
    .muted{color:var(--muted)}
    .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);display:inline-block}
    .tag.in{background:#0d2a22;border-color:#1b5a4b;color:#7cf2dd}
    .tag.out{background:#2a1018;border-color:#6b2337;color:#ff9bb0}
    .tag.rec{background:#1b2338;border-color:#2b3b63;color:#b7c8ff}
    .right{display:flex;gap:8px;align-items:center;justify-content:flex-end}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:#0e162a;border:1px solid var(--line);padding:10px 12px;border-radius:12px;display:none;max-width:min(900px, calc(100% - 24px))}
    .toast.show{display:block}
    /* modal */
    .modalBg{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;padding:16px}
    .modalBg.show{display:flex}
    .modal{width:min(560px,100%);background:#0e162a;border:1px solid var(--line);border-radius:16px;padding:14px}
    .modal h3{margin:0 0 10px;font-size:14px}
    .modal .row{gap:10px}
    .modal .row > *{flex:1}
    .small{font-size:12px;color:var(--muted)}
    .nowrap{white-space:nowrap}
    code.k{background:#0b1220;border:1px solid var(--line);padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand">
      <h1>Ã–deme Takip</h1>
      <small class="muted">Firebase (Auth + Firestore) â€” Tek dosya HTML</small>
    </div>
    <div class="controls">
      <span id="userPill" class="pill" style="display:none;">
        <span>ğŸ‘¤</span><span id="userEmail" class="nowrap"></span>
      </span>
      <button id="btnLogout" class="btn ghost" style="display:none;">Ã‡Ä±kÄ±ÅŸ</button>
    </div>
  </header>

  <!-- AUTH -->
  <div id="authCard" class="card">
    <h2>GiriÅŸ</h2>
    <div class="row">
      <input id="email" type="email" placeholder="E-posta" autocomplete="email" />
      <input id="pass" type="password" placeholder="Åifre" autocomplete="current-password" />
    </div>
    <div class="row" style="margin-top:10px;">
      <button id="btnLogin" class="btn primary">GiriÅŸ Yap</button>
      <button id="btnRegister" class="btn">KayÄ±t Ol</button>
      <span class="small">Not: Firebase Console â†’ Authenticationâ€™de Email/Password etkin olmalÄ±.</span>
    </div>
    <div class="hr"></div>
    <div class="small">
      Kurulum: Bu dosyada <code class="k">firebaseConfig</code> alanÄ±nÄ± kendi projenle doldur.
    </div>
  </div>

  <!-- APP -->
  <div id="app" style="display:none;">
    <!-- KPIs -->
    <div class="grid3" style="margin-bottom:12px;">
      <div class="card kpi">
        <div class="l">Toplam BorÃ§ (Ã‡Ä±kÄ±ÅŸ)</div>
        <div class="v bad" id="kpiOut">â‚º0</div>
        <div class="small" id="kpiOutInfo"></div>
      </div>
      <div class="card kpi">
        <div class="l">Toplam Alacak (GiriÅŸ)</div>
        <div class="v ok" id="kpiIn">â‚º0</div>
        <div class="small" id="kpiInInfo"></div>
      </div>
      <div class="card kpi">
        <div class="l">Alacak FazlasÄ± / BorÃ§ FazlasÄ± (Net)</div>
        <div class="v" id="kpiNet">â‚º0</div>
        <div class="small">Net = GiriÅŸ âˆ’ Ã‡Ä±kÄ±ÅŸ</div>
      </div>
    </div>

    <!-- Toolbar -->
    <div class="card" style="margin-bottom:12px;">
      <div class="toolbar">
        <div class="controls">
          <button id="btnPrevMonth" class="btn">â—€</button>
          <span class="pill">
            <span>ğŸ“…</span><strong id="monthLabel">â€”</strong>
          </span>
          <button id="btnNextMonth" class="btn">â–¶</button>

          <select id="statusFilter">
            <option value="all">Durum: Hepsi</option>
            <option value="unpaid">Durum: Ã–denmemiÅŸ</option>
            <option value="paid">Durum: Ã–dendi</option>
          </select>

          <select id="typeFilter">
            <option value="all">TÃ¼r: Hepsi</option>
            <option value="out">TÃ¼r: Ã‡Ä±kÄ±ÅŸ</option>
            <option value="in">TÃ¼r: GiriÅŸ</option>
          </select>

          <input id="q" placeholder="Ara (aÃ§Ä±klama)" />
        </div>

        <div class="controls">
          <button id="btnAddPayment" class="btn primary">+ Yeni Ã–deme</button>
          <button id="btnAddRecurring" class="btn ok">+ Tekrarlayan</button>
        </div>
      </div>

      <div class="small" style="margin-top:10px;">
        Tekrarlayan Ã§oÄŸalma sorunu Ã§Ã¶zÃ¼ldÃ¼: her ay iÃ§in Ã¶deme dokÃ¼manÄ± <code class="k">recurrenceId_YYYY-MM</code> olarak <b>tekil</b> Ã¼retilir (idempotent).
      </div>
    </div>

    <!-- List -->
    <div class="card">
      <h2>Ã–demeler</h2>
      <div class="small muted" id="listInfo"></div>
      <div style="overflow:auto;margin-top:8px;">
        <table class="list" id="tbl">
          <thead>
            <tr>
              <th>Tarih</th>
              <th>TÃ¼r</th>
              <th>AÃ§Ä±klama</th>
              <th class="right">Tutar</th>
              <th>Durum</th>
              <th>Kaynak</th>
              <th class="right">Ä°ÅŸlem</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- PAYMENT MODAL -->
<div id="payModalBg" class="modalBg">
  <div class="modal">
    <div class="right" style="justify-content:space-between;">
      <h3>Yeni Ã–deme</h3>
      <button class="btn ghost" id="payClose">âœ•</button>
    </div>

    <div class="row">
      <select id="payType">
        <option value="out">Ã‡Ä±kÄ±ÅŸ (BorÃ§)</option>
        <option value="in">GiriÅŸ (Alacak)</option>
      </select>

      <select id="payStatus">
        <option value="unpaid">Ã–denmemiÅŸ</option>
        <option value="paid">Ã–dendi</option>
      </select>
    </div>

    <div class="row" style="margin-top:10px;">
      <input id="payDate" type="date" />
      <input id="payAmount" type="number" step="0.01" placeholder="Tutar" />
    </div>

    <div class="row" style="margin-top:10px;">
      <input id="payDesc" placeholder="AÃ§Ä±klama" />
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="paySave" class="btn primary">Kaydet</button>
      <button id="payCancel" class="btn">VazgeÃ§</button>
    </div>
    <div class="small muted" style="margin-top:10px;">
      Not: Tarih seÃ§ilmezse seÃ§ili ayÄ±n 1â€™i alÄ±nÄ±r.
    </div>
  </div>
</div>

<!-- RECURRING MODAL -->
<div id="recModalBg" class="modalBg">
  <div class="modal">
    <div class="right" style="justify-content:space-between;">
      <h3>Tekrarlayan Ã–deme</h3>
      <button class="btn ghost" id="recClose">âœ•</button>
    </div>

    <div class="row">
      <select id="recType">
        <option value="out">Ã‡Ä±kÄ±ÅŸ (BorÃ§)</option>
        <option value="in">GiriÅŸ (Alacak)</option>
      </select>

      <select id="recDay">
        <option value="1">AyÄ±n 1â€™i</option>
        <option value="5">AyÄ±n 5â€™i</option>
        <option value="10">AyÄ±n 10â€™u</option>
        <option value="15">AyÄ±n 15â€™i</option>
        <option value="20">AyÄ±n 20â€™si</option>
        <option value="25">AyÄ±n 25â€™i</option>
      </select>
    </div>

    <div class="row" style="margin-top:10px;">
      <input id="recAmount" type="number" step="0.01" placeholder="Tutar" />
      <input id="recMonths" type="number" min="1" max="60" value="12" placeholder="KaÃ§ ay tekrarlansÄ±n?" />
    </div>

    <div class="row" style="margin-top:10px;">
      <input id="recDesc" placeholder="AÃ§Ä±klama" />
    </div>

    <div class="row" style="margin-top:10px;">
      <button id="recSave" class="btn ok">Kaydet</button>
      <button id="recCancel" class="btn">VazgeÃ§</button>
    </div>

    <div class="small muted" style="margin-top:10px;">
      OluÅŸan kayÄ±tlar her ay <b>tek bir kez</b> gÃ¶rÃ¼nÃ¼r. Yeni aya geÃ§ince â€œdefalarcaâ€ Ã§oÄŸalma olmaz.
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
  // ===== Firebase (Modular v9) CDN =====
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
  import {
    getAuth,
    onAuthStateChanged,
    signInWithEmailAndPassword,
    createUserWithEmailAndPassword,
    signOut
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";
  import {
    getFirestore,
    doc,
    setDoc,
    getDoc,
    addDoc,
    deleteDoc,
    updateDoc,
    collection,
    query,
    where,
    orderBy,
    onSnapshot,
    getDocs,
    serverTimestamp
  } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js";

  // ================== 1) Firebase Config (DOLDUR) ==================
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  // ================== Utils ==================
  const fmt = new Intl.NumberFormat("tr-TR", { style:"currency", currency:"TRY" });
  const $ = (id) => document.getElementById(id);

  function toast(msg){
    const t = $("toast");
    t.textContent = msg;
    t.classList.add("show");
    setTimeout(()=>t.classList.remove("show"), 2400);
  }

  function pad2(n){ return String(n).padStart(2,"0"); }
  function ymFromDate(d){
    return `${d.getFullYear()}-${pad2(d.getMonth()+1)}`;
  }
  function nextMonth(ym){
    const [y,m] = ym.split("-").map(Number);
    const d = new Date(y, m-1, 1);
    d.setMonth(d.getMonth()+1);
    return ymFromDate(d);
  }
  function prevMonth(ym){
    const [y,m] = ym.split("-").map(Number);
    const d = new Date(y, m-1, 1);
    d.setMonth(d.getMonth()-1);
    return ymFromDate(d);
  }
  function dateStrFor(ym, day){
    const [y,m] = ym.split("-").map(Number);
    const d = new Date(y, m-1, 1);
    const lastDay = new Date(y, m, 0).getDate();
    const dd = Math.min(Number(day), lastDay);
    return `${y}-${pad2(m)}-${pad2(dd)}`;
  }

  // ================== Init ==================
  let app, auth, db;
  try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    db = getFirestore(app);
  } catch (e){
    console.error(e);
    toast("Firebase config hatalÄ± / eksik.");
  }

  // ================== State ==================
  let selectedMonth = ymFromDate(new Date()); // varsayÄ±lan: iÃ§inde bulunduÄŸumuz ay
  let unsubPayments = null;

  // ================== DOM refs ==================
  const authCard = $("authCard");
  const appEl = $("app");
  const userPill = $("userPill");
  const userEmail = $("userEmail");
  const btnLogout = $("btnLogout");

  // ================== Auth handlers ==================
  $("btnLogin").onclick = async () => {
    const email = $("email").value.trim();
    const pass = $("pass").value;
    if(!email || !pass) return toast("E-posta/ÅŸifre gir.");
    try{
      await signInWithEmailAndPassword(auth, email, pass);
    }catch(e){
      console.error(e);
      toast("GiriÅŸ hatasÄ±: " + (e.code || e.message));
    }
  };

  $("btnRegister").onclick = async () => {
    const email = $("email").value.trim();
    const pass = $("pass").value;
    if(!email || !pass) return toast("E-posta/ÅŸifre gir.");
    try{
      await createUserWithEmailAndPassword(auth, email, pass);
      toast("KayÄ±t tamam. GiriÅŸ yapÄ±ldÄ±.");
    }catch(e){
      console.error(e);
      toast("KayÄ±t hatasÄ±: " + (e.code || e.message));
    }
  };

  btnLogout.onclick = async () => {
    try{ await signOut(auth); }catch(e){ console.error(e); }
  };

  // ================== UI helpers ==================
  function setMonthUI(){
    $("monthLabel").textContent = selectedMonth;
  }

  function openModal(bg){ bg.classList.add("show"); }
  function closeModal(bg){ bg.classList.remove("show"); }

  // Payment modal
  const payBg = $("payModalBg");
  $("btnAddPayment").onclick = () => {
    $("payType").value = "out";
    $("payStatus").value = "unpaid";
    $("payAmount").value = "";
    $("payDesc").value = "";
    $("payDate").value = dateStrFor(selectedMonth, 1);
    openModal(payBg);
  };
  $("payClose").onclick = () => closeModal(payBg);
  $("payCancel").onclick = () => closeModal(payBg);
  payBg.addEventListener("click", (e)=>{ if(e.target === payBg) closeModal(payBg); });

  // Recurring modal
  const recBg = $("recModalBg");
  $("btnAddRecurring").onclick = () => {
    $("recType").value = "out";
    $("recDay").value = "1";
    $("recAmount").value = "";
    $("recMonths").value = "12";
    $("recDesc").value = "";
    openModal(recBg);
  };
  $("recClose").onclick = () => closeModal(recBg);
  $("recCancel").onclick = () => closeModal(recBg);
  recBg.addEventListener("click", (e)=>{ if(e.target === recBg) closeModal(recBg); });

  // ================== Core fix: idempotent recurring generation ==================
  async function listRecurring(uid){
    const qRec = query(collection(db, "users", uid, "recurring"), orderBy("createdAt", "desc"));
    const snap = await getDocs(qRec);
    return snap.docs.map(d => ({ id: d.id, ...d.data() }));
  }

  // For a given recurring definition and month, ensure only ONE payment doc exists:
  // paymentId = `${recurrenceId}_${YYYY-MM}`
  async function ensureRecurringPaymentForMonth(uid, recurring, ym){
    const paymentId = `${recurring.id}_${ym}`;
    const ref = doc(db, "users", uid, "payments", paymentId);

    // if user already edited that payment manually later, we still keep it; merge:true avoids clobber.
    const date = dateStrFor(ym, recurring.dayOfMonth || 1);
    await setDoc(ref, {
      id: paymentId,
      month: ym,
      date,
      type: recurring.type, // 'in'|'out'
      amount: Number(recurring.amount || 0),
      description: recurring.description || "",
      status: "unpaid",
      source: "recurring",
      recurrenceId: recurring.id,
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp()
    }, { merge: true });
  }

  // When user creates a recurring item that repeats for N months:
  // 1) store recurring def
  // 2) generate idempotent payment docs for each month in range (starting from selectedMonth)
  async function createRecurringAndGenerate(uid, rec){
    const recRef = await addDoc(collection(db, "users", uid, "recurring"), {
      ...rec,
      createdAt: serverTimestamp()
    });

    // generate months
    let ym = selectedMonth;
    const months = Math.max(1, Math.min(60, Number(rec.repeatMonths || 12)));
    const recurringDef = { id: recRef.id, ...rec };

    for(let i=0;i<months;i++){
      await ensureRecurringPaymentForMonth(uid, recurringDef, ym);
      ym = nextMonth(ym);
    }
  }

  // For the currently selected month, ensure all recurring defs have their single payment doc.
  async function ensureMonthRecurrings(uid, ym){
    const recs = await listRecurring(uid);
    // important: this function can run many times safely because payment doc id is deterministic.
    await Promise.all(recs.map(r => ensureRecurringPaymentForMonth(uid, r, ym)));
  }

  // ================== Payments read (real-time) ==================
  function startPaymentsListener(uid){
    if (unsubPayments) { unsubPayments(); unsubPayments = null; }

    const qPay = query(
      collection(db, "users", uid, "payments"),
      where("month", "==", selectedMonth),
      orderBy("date", "desc")
    );

    unsubPayments = onSnapshot(qPay, (snap)=>{
      const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      render(rows);
    }, (err)=>{
      console.error(err);
      toast("Okuma hatasÄ±: " + (err.code || err.message));
    });
  }

  // ================== Render + Filters + KPIs ==================
  function render(rows){
    const st = $("statusFilter").value;
    const tp = $("typeFilter").value;
    const q = $("q").value.trim().toLowerCase();

    let filtered = rows.filter(r => {
      if(st !== "all" && r.status !== st) return false;
      if(tp !== "all" && r.type !== tp) return false;
      if(q && !(String(r.description||"").toLowerCase().includes(q))) return false;
      return true;
    });

    // KPIs are computed over filtered OR full month?
    // Usually KPIs should reflect visible set? Here we compute over full month (rows), not filtered:
    const totalOut = rows.filter(r=>r.type==="out").reduce((a,r)=>a+Number(r.amount||0),0);
    const totalIn  = rows.filter(r=>r.type==="in").reduce((a,r)=>a+Number(r.amount||0),0);
    const net = totalIn - totalOut;

    $("kpiOut").textContent = fmt.format(totalOut);
    $("kpiIn").textContent  = fmt.format(totalIn);
    $("kpiNet").textContent = fmt.format(net);
    $("kpiNet").className = "v " + (net >= 0 ? "ok" : "bad");

    $("kpiOutInfo").textContent = `${selectedMonth} toplamÄ±`;
    $("kpiInInfo").textContent = `${selectedMonth} toplamÄ±`;

    $("listInfo").textContent = `${selectedMonth} iÃ§inde ${filtered.length} kayÄ±t (toplam ${rows.length}).`;

    const tbody = $("tbody");
    tbody.innerHTML = "";

    filtered.forEach(r=>{
      const tr = document.createElement("tr");

      const tagType = r.type === "in"
        ? `<span class="tag in">GiriÅŸ</span>`
        : `<span class="tag out">Ã‡Ä±kÄ±ÅŸ</span>`;

      const tagSource = r.source === "recurring"
        ? `<span class="tag rec">Tekrarlayan</span>`
        : `<span class="tag">Manuel</span>`;

      const statusText = r.status === "paid"
        ? `<span class="tag in">Ã–dendi</span>`
        : `<span class="tag out">Ã–denmemiÅŸ</span>`;

      tr.innerHTML = `
        <td class="nowrap">${(r.date || "").slice(0,10) || "-"}</td>
        <td>${tagType}</td>
        <td>${escapeHtml(r.description || "")}</td>
        <td class="right nowrap"><strong>${fmt.format(Number(r.amount||0))}</strong></td>
        <td>${statusText}</td>
        <td>${tagSource}</td>
        <td class="right">
          <button class="btn ghost" data-act="toggle" data-id="${r.id}">${r.status==="paid" ? "Ã–denmedi" : "Ã–dendi"}</button>
          <button class="btn danger" data-act="del" data-id="${r.id}">Sil</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  }

  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#039;"
    }[m]));
  }

  // ================== Actions: toggle / delete ==================
  $("tbody").addEventListener("click", async (e)=>{
    const btn = e.target.closest("button");
    if(!btn) return;
    const act = btn.dataset.act;
    const id = btn.dataset.id;
    const uid = auth.currentUser?.uid;
    if(!uid) return;

    try{
      if(act === "toggle"){
        const ref = doc(db, "users", uid, "payments", id);
        const snap = await getDoc(ref);
        if(!snap.exists()) return;
        const cur = snap.data().status || "unpaid";
        await updateDoc(ref, { status: cur === "paid" ? "unpaid" : "paid", updatedAt: serverTimestamp() });
      }
      if(act === "del"){
        // recurring payment docs can be deleted too; they will be re-created when month is ensured.
        // To permanently stop, user must delete the recurring definition (not included here for simplicity).
        const ref = doc(db, "users", uid, "payments", id);
        await deleteDoc(ref);
      }
    }catch(err){
      console.error(err);
      toast("Ä°ÅŸlem hatasÄ±: " + (err.code || err.message));
    }
  });

  // ================== Filters trigger rerender (snapshot listener calls render; we re-render with last rows?) ==================
  // Simpler: just restart listener? Not needed. We'll just keep lastRows in memory.
  let lastRows = [];
  function renderWithCache(rows){ lastRows = rows; render(rows); }

  // Patch listener to use cache
  function startPaymentsListenerPatched(uid){
    if (unsubPayments) { unsubPayments(); unsubPayments = null; }

    const qPay = query(
      collection(db, "users", uid, "payments"),
      where("month", "==", selectedMonth),
      orderBy("date", "desc")
    );

    unsubPayments = onSnapshot(qPay, (snap)=>{
      const rows = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      renderWithCache(rows);
    }, (err)=>{
      console.error(err);
      toast("Okuma hatasÄ±: " + (err.code || err.message));
    });
  }

  ["statusFilter","typeFilter","q"].forEach(id=>{
    $(id).addEventListener("input", ()=> render(lastRows));
    $(id).addEventListener("change", ()=> render(lastRows));
  });

  // ================== Month navigation (FIXED) ==================
  $("btnNextMonth").onclick = async () => {
    selectedMonth = nextMonth(selectedMonth);
    await onMonthChanged();
  };
  $("btnPrevMonth").onclick = async () => {
    selectedMonth = prevMonth(selectedMonth);
    await onMonthChanged();
  };

  async function onMonthChanged(){
    setMonthUI();
    const uid = auth.currentUser?.uid;
    if(!uid) return;

    // Ensure recurrings for this month (idempotent, no duplicates)
    try{
      await ensureMonthRecurrings(uid, selectedMonth);
    }catch(e){
      console.error(e);
      // if rules block writes, still show month list
    }

    // restart listener for that month
    startPaymentsListenerPatched(uid);
  }

  // ================== Save payment ==================
  $("paySave").onclick = async () => {
    const uid = auth.currentUser?.uid;
    if(!uid) return;

    const type = $("payType").value;
    const status = $("payStatus").value;
    const amount = Number($("payAmount").value);
    const desc = ($("payDesc").value || "").trim();
    const date = $("payDate").value || dateStrFor(selectedMonth, 1);

    if(!amount || amount <= 0) return toast("Tutar gir.");
    const month = date.slice(0,7) || selectedMonth;

    try{
      await addDoc(collection(db, "users", uid, "payments"), {
        month,
        date,
        type,
        status,
        amount,
        description: desc,
        source: "manual",
        createdAt: serverTimestamp(),
        updatedAt: serverTimestamp()
      });
      closeModal(payBg);
      toast("Kaydedildi.");
      // if user saved into different month than selected, optionally move view:
      // selectedMonth = month; await onMonthChanged();
    }catch(e){
      console.error(e);
      toast("Kaydetme hatasÄ±: " + (e.code || e.message));
    }
  };

  // ================== Save recurring ==================
  $("recSave").onclick = async () => {
    const uid = auth.currentUser?.uid;
    if(!uid) return;

    const type = $("recType").value;
    const dayOfMonth = Number($("recDay").value);
    const amount = Number($("recAmount").value);
    const repeatMonths = Number($("recMonths").value);
    const description = ($("recDesc").value || "").trim();

    if(!amount || amount <= 0) return toast("Tutar gir.");
    if(!repeatMonths || repeatMonths < 1) return toast("Tekrar ay sayÄ±sÄ± gir.");

    try{
      await createRecurringAndGenerate(uid, { type, dayOfMonth, amount, repeatMonths, description });
      closeModal(recBg);
      toast("Tekrarlayan oluÅŸturuldu.");
      // Ensure current month and reload
      await ensureMonthRecurrings(uid, selectedMonth);
      startPaymentsListenerPatched(uid);
    }catch(e){
      console.error(e);
      toast("Hata: " + (e.code || e.message));
    }
  };

  // ================== Auth state change ==================
  onAuthStateChanged(auth, async (user)=>{
    if(!user){
      authCard.style.display = "";
      appEl.style.display = "none";
      userPill.style.display = "none";
      btnLogout.style.display = "none";
      if (unsubPayments) { unsubPayments(); unsubPayments = null; }
      return;
    }

    authCard.style.display = "none";
    appEl.style.display = "";
    userPill.style.display = "inline-flex";
    btnLogout.style.display = "inline-flex";
    userEmail.textContent = user.email || "â€”";

    // init UI
    setMonthUI();

    // Ensure recurrings for current month once (idempotent)
    try{
      await ensureMonthRecurrings(user.uid, selectedMonth);
    }catch(e){
      console.error(e);
      // If Firestore rules block, user will still see list if reads allowed.
    }

    startPaymentsListenerPatched(user.uid);
  });

  // ================== Extra: Close modals with ESC ==================
  document.addEventListener("keydown", (e)=>{
    if(e.key === "Escape"){
      closeModal(payBg);
      closeModal(recBg);
    }
  });

  // ================== Dev hint ==================
  console.log("Ã–deme Takip hazÄ±r. Firebase config'i doldurmayÄ± unutma.");
</script>
</body>
</html>
